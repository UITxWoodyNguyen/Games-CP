// Code.gs
var SHEET_ID = '18QrpufQqUKCSznNEBP94NgFmcuBS-0MOxuVmIObn9Hs'; // Thay bằng ID Google Sheet của bạn
var SHEET_NAME = 'data'; // Tên sheet

function doGet(e) {
  if (e.parameter.action === 'getAvailability') {
    return getAvailability();
  }
  return ContentService.createTextOutput(JSON.stringify({error: 'Invalid action'}))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    
    if (data.action === 'submit') {
      return submitAppointment(data);
    }
    
    return ContentService.createTextOutput(JSON.stringify({error: 'Invalid action'}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function submitAppointment(data) {
  var sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
  
  sheet.appendRow([
    new Date(),
    data.fullname,
    data.class,
    data.email,
    data.position,
    data.interviewDate,
    data.interviewPeriod,
    data.interviewTime
  ]);
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    message: "Appointment saved successfully"
  })).setMimeType(ContentService.MimeType.JSON);
}

function getAvailability() {
  var sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
  var data = sheet.getDataRange().getValues();
  
  var availability = {
    "22/8": {
      "Sáng": {},
      "Trưa-Chiều": {},
      "Tối": {}
    },
    "23/8": {
      "Sáng": {},
      "Trưa-Chiều": {},
      "Tối": {}
    }
  };
  
  // Khởi tạo tất cả các khung giờ với 4 slot trống
  initializeSlots(availability["22/8"]["Sáng"], "08:00", "10:45", 15);
  initializeSlots(availability["22/8"]["Trưa-Chiều"], "14:00", "16:45", 15);
  initializeSlots(availability["22/8"]["Tối"], "20:00", "21:45", 15);
  initializeSlots(availability["23/8"]["Sáng"], "08:00", "10:45", 15);
  initializeSlots(availability["23/8"]["Trưa-Chiều"], "14:00", "16:45", 15);
  initializeSlots(availability["23/8"]["Tối"], "20:00", "21:45", 15);
  
  // Đếm số lần đã đặt cho mỗi khung giờ
  if (data.length > 1) {
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var date = formatDate(row[5]);
      var period = row[6];
      var time = row[7];
      
      if (availability[date] && availability[date][period] && availability[date][period][time]) {
        availability[date][period][time].available--;
      }
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify(availability))
    .setMimeType(ContentService.MimeType.JSON);
}

function initializeSlots(slotsObj, startTime, endTime, intervalMinutes) {
  var [startHour, startMinute] = startTime.split(':').map(Number);
  var [endHour, endMinute] = endTime.split(':').map(Number);
  
  var currentHour = startHour;
  var currentMinute = startMinute;
  
  while (currentHour < endHour || (currentHour === endHour && currentMinute <= endMinute)) {
    var startTimeStr = `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
    
    var endHourCalc = currentHour;
    var endMinuteCalc = currentMinute + intervalMinutes;
    
    if (endMinuteCalc >= 60) {
      endHourCalc += Math.floor(endMinuteCalc / 60);
      endMinuteCalc = endMinuteCalc % 60;
    }
    
    var endTimeStr = `${endHourCalc.toString().padStart(2, '0')}:${endMinuteCalc.toString().padStart(2, '0')}`;
    var timeRange = `${startTimeStr} - ${endTimeStr}`;
    slotsObj[timeRange] = { slots: 4, available: 4 };
    
    currentMinute += intervalMinutes;
    if (currentMinute >= 60) {
      currentHour += Math.floor(currentMinute / 60);
      currentMinute = currentMinute % 60;
    }
  }
}

function formatDate(date) {
  if (!date) return '';
  if (typeof date === 'string') return date;
  
  var day = date.getDate();
  var month = date.getMonth() + 1;
  return `${day}/${month}`;
}